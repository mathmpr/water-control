<html lang="pt">
<head>
    <title>Water Control</title>
    <%- include('../common/head.ejs') %>
    <style>
        .card-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
        }

        #onWaterPump[disabled] {
            opacity: 0.6;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
        }

        * {
            user-select: none;
        }

        #info {
            width: 100%;
        }

        @media (max-width: 768px) {
            .table, .table thead, .table tbody, .table th, .table td, .table tr {
                display: block;
            }

            .table thead {
                display: none; /* esconde cabeçalho */
            }

            .table tr {
                margin-bottom: 12px;
                border: 1px solid #ddd;
                border-radius: 12px;
                padding: 10px;
                background: #fff;
            }

            .table td {
                border: none;
                display: flex;
                justify-content: space-between;
                padding: 6px 10px;
            }

            .table td::before {
                content: attr(data-label);
                font-weight: bold;
                margin-right: 8px;
                color: #555;
            }
        }
    </style>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body class="bg-light">
<%- include('common/nav.ejs', {title: 'Water - Logs', user}) %>
<div class="container" style="margin-top: 40px;">

    <% if (user.roles.includes('user')) { %>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2></h2>
            <a id="onWaterPump" class="btn btn-primary">Ligar a bomba</a>
        </div>
    <% } %>

    <div class="row">
        <div class="col-12">
            <table class="table table-striped table-hover align-middle shadow-sm rounded">
                <thead class="table-dark">
                <tr>
                    <% if (user.roles.includes('admin')) { %>
                        <th scope="col">Quem?</th>
                    <% } %>
                    <th scope="col">Hora</th>
                    <th scope="col">Tipo</th>
                    <th scope="col">Desligamento</th>
                    <th scope="col">Chegou água?</th>
                    <th scope="col">Ação</th>
                </tr>
                </thead>
                <tbody>
                <% logs.forEach(function(log, index) { %>
                    <tr>
                        <% if (user.roles.includes('admin')) { %>
                            <td data-label="Quem?"><strong><%= log.user.name %></strong></td>
                        <% } %>
                        <td data-label="Hora">
                            <%= new Date(new Date(log.created_at).getTime() - (3 * 60 * 60 * 1000))
                                    .toLocaleTimeString('pt-BR', {
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit'
                                    }) %>
                        </td>
                        <td data-label="Tipo">
                            <span class="badge <%= log.trigger_type === "auto" ? "bg-success" : "bg-primary" %>"><%= log.trigger_type %></span>
                        </td>
                        <td data-label="Desligamento">
                            <% if ((['manual', 'online', 'alexa'].includes(log.trigger_type)) && log.value < 1) { %>
                                <span class="badge bg-success">manual</span>
                            <% } else { %>
                                <% if (log.value < 1 && log.detect < 1) { %>
                                    <span class="badge bg-danger">pelo tempo</span>
                                <% } else if(log.value < 1 && log.detect > 0) { %>
                                    <span class="badge bg-success">pelo sensor</span>
                                <% } else { %>
                                    <span class="badge bg-success">n/a</span>
                                <% } %>
                            <% } %>
                        </td>
                        <td data-label="Chegou água?">
                            <% if (log.income > 0) { %>
                                <span class="badge bg-success">Sim</span>
                            <% } else { %>
                                <% if (log.value < 1) { %>
                                    <span class="badge bg-success">n/a</span>
                                <% } else { %>
                                    <span class="badge bg-danger">Não</span>
                                <% } %>
                            <% } %>
                        </td>
                        <td data-label="Ação">
                            <% if (log.value > 0) { %>
                                <span class="badge bg-success">ligado</span>
                            <% } else { %>
                                <span class="badge bg-secondary">desligado</span>
                            <% } %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
            <div id="info" class="mt-3 p-3 mb-3 bg-light border rounded shadow-sm">
                <p class="mb-1"><strong>Ping {asker}:</strong> <span class="asker text-primary"></span></p>
                <!--p class="mb-1"><strong>Dc {asker}:</strong> <span class="asker-dc text-primary"></span></p-->
                <p class="mb-0"><strong>Ping {sender}:</strong> <span class="sender text-primary"></span></p>
                <!--p class="mb-0"><strong>Dc {sender}:</strong> <span class="sender-dc text-primary"></span></p-->
            </div>
        </div>
    </div>
</div>

<%- include('../common/end.ejs') %>
<script>
    let client;

    const onOffWaterTopic = "on_off/water";
    const getStatusTopic = "get/status";
    const onStatusTopic = "on/status";
    const onKeepAliveTopic = "on/keep_alive";
    const newLogAddedTopic = "new/log_added";
    const lastRowWaterTopic = "new/water_income";

    const token = localStorage.getItem('token');
    const username = "<%= user.username %>";

    let status = false;

    $(document).ready(function () {

        let onWaterPump = $('#onWaterPump');
        onWaterPump.attr('disabled', true);

        let senderSpan = $('#info .sender');
        // let senderSpanDc = $('#info .sender-dc');
        let askerSpan = $('#info .asker');
        // let askerSpanDc = $('#info .asker-dc');

        client = mqtt.connect("<%= isLocal ? "ws://localhost:1888" : "wss://water.mathmpr.com" %>");

        client.on("message", (topic, message) => {
            if (topic === onStatusTopic) {
                let data = JSON.parse(message.toString());
                status = data.status;
                senderSpan.text(data.senderPing);
                // senderSpanDc.text(data.senderDc);
                askerSpan.text(data.askerPing);
                // askerSpanDc.text(data.askerDc);
                if (status) {
                    onWaterPump.text('Desligar a bomba');
                } else {
                    onWaterPump.text('Ligar a bomba');
                }
            } else if (topic === onKeepAliveTopic) {
                let data = JSON.parse(message.toString());
                senderSpan.text(data.senderPing);
                // senderSpanDc.text(data.senderDc);
                askerSpan.text(data.askerPing);
                // askerSpanDc.text(data.askerDc);
            } else if (topic === newLogAddedTopic) {
                let log = JSON.parse(message.toString());
                let tableBody = $('table tbody');
                let newRow = `<tr>
                        <% if (user.roles.includes('admin')) { %>
                            <td data-label="Quem?"><strong>${log.user.name}</strong></td>
                        <% } %>
                        <td data-label="Hora">
                            ${new Date(new Date(log.created_at).getTime())
                                .toLocaleTimeString('pt-BR', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit'
                                })}
                        </td>
                        <td data-label="Tipo">
                            <span class="badge ${log.trigger_type === "auto" ? "bg-success"
                    : "bg-primary"}">${log.trigger_type}</span>
                        </td>
                        <td data-label="Desligamento">
                            ${((['manual', 'online', 'alexa'].includes(log.trigger_type)) && log.value < 1) ? `<span class="badge bg-success">manual</span>` : (log.value < 1 && log.detect < 1 ? `<span class="badge bg-danger">pelo tempo</span>` : (log.value < 1 && log.detect > 0 ? `<span class="badge bg-success">pelo sensor</span>` : `<span class="badge bg-success">n/a</span>`))}
                        </td>
                        <td data-label="Chegou água?">
                            ${log.income > 0 ? `<span class="badge bg-success">Sim</span>` : (log.value < 1 ? `<span class="badge bg-success">n/a</span>` : `<span class="badge bg-danger">Não</span>`)}
                        </td>
                        <td data-label="Ação">
                            ${log.value > 0 ? `<span class="badge bg-success">ligado</span>` : `<span class="badge bg-secondary">desligado</span>`}
                        </td>
                    </tr>`;
                tableBody.append(newRow);
            } else if (topic === lastRowWaterTopic) {
                $('table tbody tr:last-child').find('td[data-label="Chegou água?"]').html('<span class="badge bg-success">Sim</span>');
            }
        });

        client.on('connect', function () {
            onWaterPump.attr('disabled', false);
            client.subscribe(onStatusTopic);
            client.subscribe(onKeepAliveTopic);
            client.subscribe(newLogAddedTopic);
            client.subscribe(lastRowWaterTopic);
            setTimeout(() => {
                client.publish(getStatusTopic, `${token}:${username}`);
            }, 200);
        });

        onWaterPump.on('click', function () {
            if (onWaterPump.attr('disabled')) {
                return;
            }
            onWaterPump.attr('disabled', true);
            client.publish(onOffWaterTopic, `${token}:${username}:online:${(status ? '0' : '1')}`);
            toastr.info(`Bomba ${(status ? 'desligada' : 'ligada')} com sucesso! Aguarde um momento para poder realizar outra ação.`);
            setTimeout(function () {
                onWaterPump.attr('disabled', false);
            }, 5000);
        });
    });
</script>
</body>
</html>